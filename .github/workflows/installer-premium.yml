name: Mikhmon Premium Installer CI/CD

on:
  push:
    branches:
      - install-multi-premium
  pull_request:
    branches:
      - install-multi-premium
  workflow_dispatch:

jobs:
  build:
    name: ğŸ”§ Validate & Build Installer
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ” Install ShellCheck (Bash Linter)
        run: sudo apt-get install -y shellcheck

      - name: ğŸ§ª Validate Script (No Critical Errors)
        run: |
          echo "Running ShellCheck..."
          shellcheck installer-mikhmon.sh || true

      - name: ğŸ”‘ Set Executable Permission
        run: chmod +x installer-mikhmon.sh

      - name: ğŸ“¦ Upload Installer Artifact
        uses: actions/upload-artifact@v4
        with:
          name: installer-premium
          path: installer-mikhmon.sh

  release:
    name: ğŸš€ Publish to RELEASE Branch
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/install-multi-premium'

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Ensure Permissions
        run: chmod +x installer-mikhmon.sh

      - name: ğŸ”„ Sync to release branch
        run: |
          git config user.name "Hendri"
          git config user.email "github-actions@users.noreply.github.com"

          git checkout -B release
          cp installer-mikhmon.sh ./installer-mikhmon.sh

          git add installer-mikhmon.sh
          git commit -m "Auto-update installer from CI/CD"
          git push -f origin release

      - name: ğŸ“¢ Create Release Tag (Optional)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v1.1-premium
          name: "Mikhmon Premium Installer v1.1"
          body: |
            ğŸ”¥ **Mikhmon Multi Installer â€“ PREMIUM v1.1**
            - Auto HTTPS
            - Multi Repo: Agent, PPP6, PPP7, GenieACS
            - Auto Nginx
            - Premium color UI

          files: |
            installer-mikhmon.sh
